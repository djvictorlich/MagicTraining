<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Training</title>
    
    <!-- PWA –º–µ—Ç–∞-—Ç–µ–≥–∏ -->
    <link rel="manifest" href="/MagicTraining/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Magic Gym">
    <meta name="theme-color" content="#007AFF">
    <meta name="description" content="–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫">
    
    <!-- –ò–∫–æ–Ω–∫–∏ –¥–ª—è iOS -->
    <link rel="apple-touch-icon" href="/MagicTraining/icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/MagicTraining/icons/icon-180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/MagicTraining/icons/icon-167.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/MagicTraining/icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/MagicTraining/icons/icon-120.png">
    <link rel="icon" href="/MagicTraining/icons/icon-152.png" type="image/png">
    
    <!-- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Kinescope Player -->
    <script src="https://player.kinescope.io/latest/player.js"></script>
    
    <style>
        :root {
            --bg: #f2f2f7;
            --card: #ffffff;
            --primary: #007aff;
            --primary-dark: #0056cc;
            --secondary: #5856d6;
            --text: #1c1c1e;
            --text-secondary: #8e8e93;
            --border: #c7c7cc;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --rest-timer: #ff9500;
        }
        
        @supports (padding: max(0px)) {
            :root {
                --safe-area-inset-bottom: max(12px, env(safe-area-inset-bottom));
            }
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .screen {
            padding: 20px 20px calc(80px + var(--safe-area-inset-bottom)) 20px;
            min-height: 100vh;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background: var(--card);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 16px;
            box-shadow: 
                0 2px 10px rgba(0,0,0,0.03),
                0 1px 3px rgba(0,0,0,0.05);
            border: 0.5px solid rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            cursor: pointer;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 5px 20px rgba(0,0,0,0.08),
                0 2px 5px rgba(0,0,0,0.1);
        }
        
        .card:active {
            transform: translateY(0);
            opacity: 0.9;
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
        h1 {
            font-size: 34px;
            font-weight: 800;
            margin: 0 0 24px 0;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        h2 {
            font-size: 20px;
            font-weight: 700;
            margin: 0 0 4px 0;
            color: var(--text);
        }
        
        .day-badge {
            display: inline-block;
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            box-shadow: 0 2px 5px rgba(0,122,255,0.2);
        }
        
        /* –¢–µ—Ö–Ω–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è */
        .tech-text {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text);
            white-space: pre-line;
            margin-bottom: 15px;
        }
        
        .tech-text b {
            color: var(--primary);
        }
        
        /* –í–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .video-container {
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 16/9;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        #kinescope-player {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        button {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            width: 100%;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            position: relative;
            overflow: hidden;
        }
        
        button:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(40, 40);
                opacity: 0;
            }
        }
        
        button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,122,255,0.3);
        }
        
        button:active {
            transform: translateY(0);
            background: #0047cc;
        }
        
        .btn-secondary {
            background: rgba(0,122,255,0.1);
            color: var(--primary);
            margin-top: 12px;
        }
        
        .btn-secondary:hover {
            background: rgba(0,122,255,0.15);
            box-shadow: 0 4px 10px rgba(0,122,255,0.1);
        }
        
        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        .input-box {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .input-box label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            padding-left: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        input {
            background: #f2f2f7;
            border: 2px solid transparent;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            font-family: -apple-system, sans-serif;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            width: 100%;
            box-sizing: border-box;
        }
        
        input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }
        
        /* –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏ —É input number */
        input[type="number"] {
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .set-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
            width: 100%;
        }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            display: flex;
            justify-content: space-around;
            padding: 12px 0 calc(12px + var(--safe-area-inset-bottom)) 0;
            border-top: 0.5px solid rgba(0,0,0,0.1);
            box-shadow: 0 -2px 20px rgba(0,0,0,0.05);
            z-index: 1000;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .nav-item {
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 11px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 33%;
            padding: 8px;
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        
        .nav-item.active {
            color: var(--primary);
            background: rgba(0,122,255,0.1);
        }
        
        .nav-item i {
            font-size: 22px;
            margin-bottom: 4px;
        }
        
        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
        .progress-container {
            background: rgba(0,122,255,0.1);
            height: 4px;
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007AFF, #5856D6);
            border-radius: 2px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(0,122,255,0.3);
        }
        
        /* –¢–∞–π–º–µ—Ä –æ—Ç–¥—ã—Ö–∞ */
        .rest-timer-container {
            position: fixed;
            bottom: 120px;
            right: 20px;
            z-index: 1000;
            animation: slideInUp 0.3s ease;
        }
        
        .rest-timer {
            background: linear-gradient(135deg, #FF9500, #FF2D55);
            color: white;
            padding: 15px 20px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(255,149,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
            backdrop-filter: blur(10px);
        }
        
        .rest-timer-time {
            font-size: 32px;
            font-weight: 800;
            margin: 5px 0;
            font-variant-numeric: tabular-nums;
        }
        
        .rest-timer-label {
            font-size: 12px;
            opacity: 0.9;
            text-align: center;
        }
        
        .rest-timer-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .rest-timer-controls button {
            padding: 8px 12px;
            font-size: 13px;
            width: auto;
            flex: 1;
            background: rgba(255,255,255,0.2);
        }
        
        .rest-timer-controls button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        @keyframes slideInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(28,28,30,0.95);
            color: white;
            padding: 14px 24px;
            border-radius: 14px;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 90%;
            font-size: 14px;
            text-align: center;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stat-card {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,122,255,0.2);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 800;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        select {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--card);
            font-size: 16px;
            font-family: -apple-system, sans-serif;
            color: var(--text);
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%238e8e93'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 20px;
        }
        
        select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .screen:not(.hidden) {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 380px) {
            .screen {
                padding: 16px 16px calc(70px + var(--safe-area-inset-bottom)) 16px;
            }
            
            h1 {
                font-size: 28px;
            }
            
            .rest-timer-container {
                bottom: 110px;
                right: 16px;
            }
        }
        
        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 360px) {
            .set-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            input {
                font-size: 16px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>

<div id="app">
    <!-- –≠–∫—Ä–∞–Ω –¥–æ–º–∞—à–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div id="screen-home" class="screen">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h1>Magic Training</h1>
            <div style="display: flex; gap: 10px;">
                <button onclick="syncData()" style="width: auto; padding: 8px 12px; background: rgba(0,122,255,0.1); color: var(--primary);">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button onclick="startRestTimer(60)" style="width: auto; padding: 8px 12px; background: rgba(255,149,0,0.1); color: var(--warning);">
                    <i class="fas fa-clock"></i>
                </button>
            </div>
        </div>
        
        <div class="card" onclick="startWorkout(0)">
            <div class="day-badge">–î–ï–ù–¨ 1</div>
            <h2>–ì—Ä—É–¥—å + –°–ø–∏–Ω–∞ + –ö–æ—Ä</h2>
            <p style="color: var(--text-secondary); margin: 8px 0 0 0; font-size: 15px;">
                7 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π ‚Ä¢ ~60 –º–∏–Ω—É—Ç
            </p>
            <div style="display: flex; align-items: center; margin-top: 12px;">
                <div style="flex: 1; height: 4px; background: rgba(0,122,255,0.1); border-radius: 2px;">
                    <div id="day1-progress" style="width: 0%; height: 100%; background: var(--primary); border-radius: 2px; transition: width 0.5s ease;"></div>
                </div>
                <span id="day1-percent" style="margin-left: 10px; font-size: 13px; color: var(--primary); font-weight: 600; min-width: 40px;">0%</span>
            </div>
        </div>
        
        <div class="card" onclick="startWorkout(1)">
            <div class="day-badge" style="background: linear-gradient(135deg, #FF9500, #FF2D55);">–î–ï–ù–¨ 2</div>
            <h2>–ù–æ–≥–∏ + –ö–æ—Ä</h2>
            <p style="color: var(--text-secondary); margin: 8px 0 0 0; font-size: 15px;">
                7 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π ‚Ä¢ ~60 –º–∏–Ω—É—Ç
            </p>
            <div style="display: flex; align-items: center; margin-top: 12px;">
                <div style="flex: 1; height: 4px; background: rgba(0,122,255,0.1); border-radius: 2px;">
                    <div id="day2-progress" style="width: 0%; height: 100%; background: #FF9500; border-radius: 2px; transition: width 0.5s ease;"></div>
                </div>
                <span id="day2-percent" style="margin-left: 10px; font-size: 13px; color: #FF9500; font-weight: 600; min-width: 40px;">0%</span>
            </div>
        </div>
        
        <div class="card" onclick="startWorkout(2)">
            <div class="day-badge" style="background: linear-gradient(135deg, #34C759, #32D74B);">–î–ï–ù–¨ 3</div>
            <h2>–ü–ª–µ—á–∏ + –†—É–∫–∏ + –ö–æ—Ä</h2>
            <p style="color: var(--text-secondary); margin: 8px 0 0 0; font-size: 15px;">
                9 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π ‚Ä¢ ~70 –º–∏–Ω—É—Ç
            </p>
            <div style="display: flex; align-items: center; margin-top: 12px;">
                <div style="flex: 1; height: 4px; background: rgba(0,122,255,0.1); border-radius: 2px;">
                    <div id="day3-progress" style="width: 0%; height: 100%; background: #34C759; border-radius: 2px; transition: width 0.5s ease;"></div>
                </div>
                <span id="day3-percent" style="margin-left: 10px; font-size: 13px; color: #34C759; font-weight: 600; min-width: 40px;">0%</span>
            </div>
        </div>
        
        <div class="card" style="text-align: center; background: linear-gradient(135deg, rgba(0,122,255,0.1), rgba(88,86,214,0.1));">
            <h3 style="margin: 0 0 10px 0;">üéØ –¶–µ–ª—å –Ω–µ–¥–µ–ª–∏</h3>
            <p style="margin: 0; color: var(--text-secondary);">
                3 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Ä¢ <span id="weekly-goal">0</span>/12,500 –∫–≥ –æ–±—â–∏–π —Ç–æ–Ω–Ω–∞–∂
            </p>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
    <div id="screen-exercise" class="screen hidden">
        <div id="ex-content"></div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div id="screen-stats" class="screen hidden">
        <h1>–ü—Ä–æ–≥—Ä–µ—Å—Å</h1>
        
        <div class="stat-card">
            <div class="stat-label">–û–±—â–∏–π —Ç–æ–Ω–Ω–∞–∂</div>
            <div class="stat-value" id="total-volume">0 –∫–≥</div>
            <div class="stat-label">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</div>
        </div>
        
        <div class="card">
            <h3 style="margin-top: 0;">üìà –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</h3>
            <select id="chart-select" onchange="initChart()">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</option>
            </select>
            <div style="height: 250px; margin-top: 20px; position: relative;">
                <canvas id="mainChart"></canvas>
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin: 24px 0 12px 0;">
            <h3 style="margin: 0;">üìù –ò—Å—Ç–æ—Ä–∏—è</h3>
            <button onclick="clearHistory()" style="width: auto; padding: 8px 16px; background: rgba(255,59,48,0.1); color: var(--danger);">
                –û—á–∏—Å—Ç–∏—Ç—å
            </button>
        </div>
        
        <div id="history-list"></div>
    </div>

    <!-- –¢–∞–π–º–µ—Ä –æ—Ç–¥—ã—Ö–∞ -->
    <div id="rest-timer-container" class="rest-timer-container hidden"></div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="nav">
        <button class="nav-item active" onclick="showScreen('home')">
            <i class="fas fa-dumbbell"></i>
            <span>–¢—Ä–µ–Ω–∏–Ω–≥</span>
        </button>
        <button class="nav-item" onclick="showScreen('stats')">
            <i class="fas fa-chart-line"></i>
            <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
        </button>
    </nav>
    
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="toast" class="toast"></div>
</div>

<script>
// === –ö–û–ù–°–¢–ê–ù–¢–´ ===
const KINESCOPE_VIDEOS = {
    // –î–ï–ù–¨ 1
    'v1_1.mp4': 'pS6oD4bPt6oVpXHBoDBXRA',
    'v1_2.mp4': 'sbbgz7Mr2Jw1abV7DmVogf',
    'v1_3.mp4': 'tjin1BtqHgbGdgJne8TVfa',
    'v1_4.mp4': 'abJzGEsPWYPiUTcqXZYxir',
    'v1_5.mp4': 'bkLeUjRBuuaDhbG3mZhJcL',
    'v1_6.mp4': 'jdtNWSW1VrUk8tHtgpJFdS',
    'v1_7.mp4': 'ofNNVecTf574ZSAnmcnELv',
    
    // –î–ï–ù–¨ 2
    'v2_1.mp4': '5BU1PAabmcnW7QArZvfP6y',
    'v2_2.mp4': '8EcXZqHkLx75ryU1YQ7e7z',
    'v2_3.mp4': 'kSpywTwF3EdpvmDzxfzKez',
    'v2_4.mp4': '8hYDDXMgupefMuKCk4Xdeb',
    'v2_5.mp4': 'rkbnq5EVCCufAqRkdFhtuB',
    'v2_6.mp4': '7HNMbqFz52iPB66JPt6oRs',
    'v2_7.mp4': 'gX4R5iCBFnE1JP6ZCnxFKg',
    
    // –î–ï–ù–¨ 3
    'v3_1.mp4': 'w8EpPpCxNckMKmKsQFXxjR',
    'v3_2.mp4': 'kEnSn2z9TXuBKN1jNofjbk',
    'v3_3.mp4': 'f3VoFvbXqXd7SuLx3wTE4f',
    'v3_4.mp4': 'ogPkXM8PEe2EjFkEHHSi5U',
    'v3_5.mp4': 'wGx2t9gfX5xJmMivAadT7J',
    'v3_6.mp4': 'ctAtX8VynSJ4Pm92Q7nu81',
    'v3_7.mp4': 'qDAAiyniZXQia86Zb9HugQ',
    'v3_8.mp4': '5FnCEvW2wQVEAtA1GBmAgi',
    'v3_9.mp4': '986UJATg7BdYmxnNEmsj4k'
};

// –ö—ç—à –¥–ª—è –≤–∏–¥–µ–æ
const videoCache = new Map();
let kinescopePlayer = null;

// === –¢–†–ï–ù–ò–†–û–í–û–ß–ù–ê–Ø –ü–†–û–ì–†–ê–ú–ú–ê ===
const program = [
    {
        day: "–î–ï–ù–¨ 1: –ì—Ä—É–¥—å + –°–ø–∏–Ω–∞ + –ö–æ—Ä",
        exercises: [
            { 
                name: "–ñ–∏–º –≤ —Ä—ã—á–∞–∂–Ω–æ–º —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ Hammer Strength", 
                tech: "‚úÖ –û—Ç—Ä–µ–≥—É–ª–∏—Ä—É–π—Ç–µ —Å–∏–¥–µ–Ω—å–µ —Ç–∞–∫, —á—Ç–æ–±—ã —Ä—É–∫–æ—è—Ç–∫–∏ –±—ã–ª–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–µ–¥–∏–Ω—ã –≥—Ä—É–¥–∏ (—Å–æ—Å–∫–æ–≤).\n‚úÖ –°–≤–µ–¥–∏—Ç–µ –ª–æ–ø–∞—Ç–∫–∏ –≤–º–µ—Å—Ç–µ –∏ –ø–ª–æ—Ç–Ω–æ –ø—Ä–∏–∂–º–∏—Ç–µ —Å–ø–∏–Ω—É –∫ —Å–ø–∏–Ω–∫–µ.\n‚úÖ –ù–∞ –≤—ã–¥–æ—Ö–µ –º–æ—â–Ω–æ –≤—ã–∂–º–∏—Ç–µ —Ä—É–∫–æ—è—Ç–∏ –≤–ø–µ—Ä–µ–¥.\n‚ùóÔ∏è –í–∞–∂–Ω–æ: –í –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–µ –Ω–µ –≤—ã–ø—Ä—è–º–ª—è–π—Ç–µ –ª–æ–∫—Ç–∏ –¥–æ –∫–æ–Ω—Ü–∞ (¬´–¥–æ —â–µ–ª—á–∫–∞¬ª), –æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –∏—Ö —á—É—Ç—å –º—è–≥–∫–∏–º–∏, —á—Ç–æ–±—ã –Ω–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞–≤–∞–ª–∞—Å—å –≤ –º—ã—à—Ü–∞—Ö.\n‚úÖ –ù–∞ –≤–¥–æ—Ö–µ –º–µ–¥–ª–µ–Ω–Ω–æ –≤–µ—Ä–Ω–∏—Ç–µ –≤–µ—Å –Ω–∞–∑–∞–¥, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—è –≥—Ä—É–¥–Ω—ã–µ –º—ã—à—Ü—ã.", 
                volume: "4 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 8‚Äì12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v1_1.mp4",
                icon: "fas fa-fire"
            },
            { 
                name: "–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞ Life Fitness", 
                tech: "‚úÖ –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –Ω–æ–≥–∏ –≤–∞–ª–∏–∫–æ–º. –•–≤–∞—Ç —à–∏—Ä–µ –ø–ª–µ—á.\n‚úÖ –°–ª–µ–≥–∫–∞ –ø—Ä–æ–≥–Ω–∏—Ç–µ –ø–æ—è—Å–Ω–∏—Ü—É, –≥—Ä—É–¥—å —Å–º–æ—Ç—Ä–∏—Ç –≤–≤–µ—Ä—Ö.\n‚úÖ –¢—è–Ω–∏—Ç–µ —Ä—É–∫–æ—è—Ç—å –∫ –∫–ª—é—á–∏—Ü–∞–º. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ —Ç—è–Ω–µ—Ç–µ –Ω–µ –∫–∏—Å—Ç—è–º–∏, –∞ –ª–æ–∫—Ç—è–º–∏ –≤–Ω–∏–∑.\n‚úÖ –í –Ω–∏–∂–Ω–µ–π —Ç–æ—á–∫–µ –ø–∞—É–∑–∞ –Ω–∞ 1 —Å–µ–∫—É–Ω–¥—É –∏ —Å–∏–ª—å–Ω–æ —Å–æ–∂–º–∏—Ç–µ –ª–æ–ø–∞—Ç–∫–∏.\n‚úÖ –ü–ª–∞–≤–Ω–æ –≤–µ—Ä–Ω–∏—Ç–µ —Ä—É–∫–æ—è—Ç—å –≤–≤–µ—Ä—Ö, —Ä–∞—Å—Ç—è–≥–∏–≤–∞—è —Å–ø–∏–Ω—É.", 
                volume: "4 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 10‚Äì12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v1_2.mp4",
                icon: "fas fa-arrow-down"
            },
            { 
                name: "–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –Ω–∞ –Ω–∞–∫–ª–æ–Ω–Ω–æ–π —Å–∫–∞–º—å–µ", 
                tech: "‚úÖ –õ—è–≥—Ç–µ, –Ω–æ–≥–∏ –∂–µ—Å—Ç–∫–æ —É–ø—Ä–∏—Ç–µ –≤ –ø–æ–ª.\n‚úÖ –ü–æ–¥–Ω–∏–º–∏—Ç–µ –≥–∞–Ω—Ç–µ–ª–∏ –Ω–∞–¥ —Å–æ–±–æ–π. –ù–∞ –≤–¥–æ—Ö–µ –æ–ø—É—Å–∫–∞–π—Ç–µ –∏—Ö –∫ –∫—Ä–∞—è–º –≥—Ä—É–¥–Ω—ã—Ö –º—ã—à—Ü.\n‚úÖ –õ–æ–∫—Ç–∏ –¥–æ–ª–∂–Ω—ã —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–µ –≤ —Å—Ç–æ—Ä–æ–Ω—ã, –∞ –Ω–µ–º–Ω–æ–≥–æ –≤–ø–µ—Ä–µ–¥ (–ø–æ–¥ —É–≥–ª–æ–º 75¬∞ –∫ –∫–æ—Ä–ø—É—Å—É).\n‚úÖ –û–ø—É—Å–∫–∞–π—Ç–µ –≥–ª—É–±–æ–∫–æ, —á—É–≤—Å—Ç–≤—É—è —Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ. –ù–∞ –≤—ã–¥–æ—Ö–µ –≤—ã–∂–º–∏—Ç–µ –≤–≤–µ—Ä—Ö.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 10‚Äì12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v1_3.mp4",
                icon: "fas fa-angle-double-up"
            },
            { 
                name: "–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Ä—ã—á–∞–∂–Ω–∞—è —Ç—è–≥–∞ Hammer", 
                tech: "‚úÖ –£–ø—Ä–∏—Ç–µ—Å—å –≥—Ä—É–¥—å—é –≤ –ø–æ–¥—É—à–∫—É. –•–≤–∞—Ç –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π.\n‚úÖ –¢—è–Ω–∏—Ç–µ —Ä—É–∫–æ—è—Ç–∏ –∫ –ø–æ—è—Å—É. –î–≤–∏–∂–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –æ—Ç–≤–µ–¥–µ–Ω–∏—è –ø–ª–µ—á –Ω–∞–∑–∞–¥, –∑–∞—Ç–µ–º –ª–æ–∫—Ç–∏.\n‚úÖ –í –ø–∏–∫–æ–≤–æ–π —Ç–æ—á–∫–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–≤–µ–¥–∏—Ç–µ –ª–æ–ø–∞—Ç–∫–∏.\n‚ùóÔ∏è –ù–µ —Ä–∞—Å–∫–∞—á–∏–≤–∞–π—Ç–µ—Å—å –∫–æ—Ä–ø—É—Å–æ–º, —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–ø–∏–Ω–∞.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 10‚Äì12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v1_4.mp4",
                icon: "fas fa-dumbbell"
            },
            { 
                name: "–°–≤–µ–¥–µ–Ω–∏–µ —Ä—É–∫ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ '–ë–∞–±–æ—á–∫–∞'", 
                tech: "‚úÖ –õ–æ–∫—Ç–∏ –¥–µ—Ä–∂–∏—Ç–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–ª–µ—á –∏ —Å–ª–µ–≥–∫–∞ —Å–æ–≥–Ω—É—Ç—ã–º–∏.\n‚úÖ –ù–∞ –≤—ã–¥–æ—Ö–µ —Å–≤–æ–¥–∏—Ç–µ —Ä—É–∫–æ—è—Ç–∏ –ø–µ—Ä–µ–¥ —Å–æ–±–æ–π. –í –º–æ–º–µ–Ω—Ç —Å–≤–µ–¥–µ–Ω–∏—è –Ω–∞–ø—Ä—è–≥–∏—Ç–µ –≥—Ä—É–¥—å –Ω–∞ 1 —Å–µ–∫—É–Ω–¥—É.\n‚úÖ –ú–µ–¥–ª–µ–Ω–Ω–æ —Ä–∞–∑–≤–æ–¥–∏—Ç–µ —Ä—É–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 12‚Äì15 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v1_5.mp4",
                icon: "fas fa-compress-alt"
            },
            { 
                name: "–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è (–ø—Ä–µ—Å—Å)", 
                tech: "‚úÖ –û–∫—Ä—É–≥–ª—è–π—Ç–µ —Å–ø–∏–Ω—É, —Å–∫—Ä—É—á–∏–≤–∞–π—Ç–µ—Å—å –≤ '—É–ª–∏—Ç–∫—É'.\n‚úÖ –ù–µ –ø–æ–¥–Ω–∏–º–∞–π—Ç–µ—Å—å —Å –ø—Ä—è–º–æ–π —Å–ø–∏–Ω–æ–π.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 15‚Äì20 —Ä–∞–∑", 
                video: "v1_6.mp4",
                icon: "fas fa-running"
            },
            { 
                name: "–ü–ª–∞–Ω–∫–∞", 
                tech: "‚úÖ –£–ø–æ—Ä –Ω–∞ –ª–æ–∫—Ç–∏ –∏ –Ω–æ—Å–∫–∏. –¢–µ–ª–æ –ø—Ä—è–º–æ–µ –∫–∞–∫ –¥–æ—Å–∫–∞.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 60 —Å–µ–∫—É–Ω–¥", 
                video: "v1_7.mp4",
                icon: "fas fa-clock"
            }
        ]
    },
    {
        day: "–î–ï–ù–¨ 2: –ù–æ–≥–∏ + –ö–æ—Ä",
        exercises: [
            { 
                name: "–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ", 
                tech: "‚úÖ –ö–æ–ª–µ–Ω–Ω—ã–π —Å—É—Å—Ç–∞–≤ —Å—Ç—Ä–æ–≥–æ –Ω–∞–ø—Ä–æ—Ç–∏–≤ –æ—Å–∏ –≤—Ä–∞—â–µ–Ω–∏—è —Ç—Ä–µ–Ω–∞–∂–µ—Ä–∞.\n‚úÖ –ù–∞ –≤—ã–¥–æ—Ö–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–ø—Ä—è–º–∏—Ç–µ –Ω–æ–≥–∏. –í –≤–µ—Ä—Ö–Ω–µ–π —Ç–æ—á–∫–∞ –∑–∞–¥–µ—Ä–∂–∏—Ç–µ—Å—å –Ω–∞ 1-2 —Å–µ–∫—É–Ω–¥—ã.\n‚úÖ –ú–µ–¥–ª–µ–Ω–Ω–æ –æ–ø—É—Å—Ç–∏—Ç–µ.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 15 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v2_1.mp4",
                icon: "fas fa-angle-up"
            },
            { 
                name: "–ñ–∏–º –Ω–æ–≥–∞–º–∏", 
                tech: "‚úÖ –ü–æ—Å—Ç–∞–≤—å—Ç–µ –Ω–æ–≥–∏ –Ω–∞ —à–∏—Ä–∏–Ω–µ –ø–ª–µ—á.\n‚úÖ –ù–∞ –≤–¥–æ—Ö–µ –æ–ø—É—Å–∫–∞–π—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –≥–ª—É–±–æ–∫–æ, –Ω–æ —Å–ª–µ–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Ç–∞–∑ –Ω–µ –æ—Ç—Ä—ã–≤–∞–ª—Å—è.\n‚úÖ –ù–∞ –≤—ã–¥–æ—Ö–µ —Ç–æ–ª–∫–∞–π—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –ø—è—Ç–∫–∞–º–∏.\n‚ùóÔ∏è –í–∞–∂–Ω–æ: –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–ø—Ä—è–º–ª—è–π—Ç–µ –∫–æ–ª–µ–Ω–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é!", 
                volume: "4 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 10‚Äì12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v2_2.mp4",
                icon: "fas fa-shoe-prints"
            },
            { 
                name: "–†—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞ —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏", 
                tech: "‚úÖ –ö–æ–ª–µ–Ω–∏ —á—É—Ç—å —Å–æ–≥–Ω—É—Ç—ã –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã.\n‚úÖ –ù–∞—á–∏–Ω–∞–π—Ç–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å –æ—Ç–≤–µ–¥–µ–Ω–∏—è —Ç–∞–∑–∞ –Ω–∞–∑–∞–¥. –ì–∞–Ω—Ç–µ–ª–∏ —Å–∫–æ–ª—å–∑—è—Ç –ø–æ –Ω–æ–≥–∞–º.\n‚úÖ –û–ø—É—Å–∫–∞–π—Ç–µ—Å—å –¥–æ —Å–µ—Ä–µ–¥–∏–Ω—ã –≥–æ–ª–µ–Ω–∏. –í—ã –¥–æ–ª–∂–Ω—ã —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–∞—Ç—è–∂–µ–Ω–∏–µ –ø–æ–¥ –∫–æ–ª–µ–Ω—è–º–∏.\n‚úÖ –ù–∞ –≤—ã–¥–æ—Ö–µ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å, —Å–∂–∏–º–∞—è —è–≥–æ–¥–∏—Ü—ã.", 
                volume: "4 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 10‚Äì12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v2_3.mp4",
                icon: "fas fa-weight-hanging"
            },
            { 
                name: "–°–≥–∏–±–∞–Ω–∏–µ –Ω–æ–≥ (–±–∏—Ü–µ–ø—Å –±–µ–¥—Ä–∞)", 
                tech: "‚úÖ –ü—Ä–∏–∂–º–∏—Ç–µ —Ç–∞–∑ –∫ —Å–∫–∞–º—å–µ –∏ –Ω–µ –æ—Ç—Ä—ã–≤–∞–π—Ç–µ –µ–≥–æ.\n‚úÖ –ë—ã—Å—Ç—Ä–æ —Å–æ–≥–Ω–∏—Ç–µ –Ω–æ–≥–∏, —Å—Ç–∞—Ä–∞—è—Å—å –∫–æ—Å–Ω—É—Ç—å—Å—è —è–≥–æ–¥–∏—Ü.\n‚úÖ –ú–µ–¥–ª–µ–Ω–Ω–æ (–Ω–∞ 3 —Å—á–µ—Ç–∞) —Ä–∞–∑–æ–≥–Ω–∏—Ç–µ –Ω–æ–≥–∏ –æ–±—Ä–∞—Ç–Ω–æ.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 12‚Äì15 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v2_4.mp4",
                icon: "fas fa-angle-down"
            },
            { 
                name: "–ü–æ–¥—ä–µ–º—ã –Ω–∞ –Ω–æ—Å–∫–∏", 
                tech: "‚úÖ –û–ø—É—Å—Ç–∏—Ç–µ –ø—è—Ç–∫–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–∏–∑–∫–æ, –∑–∞—Ç–µ–º –ø–æ–¥–Ω–∏–º–∏—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤—ã—Å–æ–∫–æ.", 
                volume: "4 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 15‚Äì20 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v2_5.mp4",
                icon: "fas fa-arrow-up"
            },
            { 
                name: "–ü–æ–¥—ä–µ–º –Ω–æ–≥ (–ø—Ä–µ—Å—Å)", 
                tech: "‚úÖ –í —É–ø–æ—Ä–µ –Ω–∞ –ª–æ–∫—Ç—è—Ö. –°—Ç–∞—Ä–∞–π—Ç–µ—Å—å –ø–æ–¥–∫—Ä—É—á–∏–≤–∞—Ç—å —Ç–∞–∑ –≤–≤–µ—Ä—Ö.\n‚úÖ –î–≤–∏–∂–µ–Ω–∏—è –ø–ª–∞–≤–Ω—ã–µ –±–µ–∑ —Ä–∞—Å–∫–∞—á–∫–∏.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 12‚Äì15 —Ä–∞–∑", 
                video: "v2_6.mp4",
                icon: "fas fa-running"
            },
            { 
                name: "–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è", 
                tech: "‚úÖ –û–∫—Ä—É–≥–ª—è–π—Ç–µ —Å–ø–∏–Ω—É, —Å–∫—Ä—É—á–∏–≤–∞–π—Ç–µ—Å—å –≤ '—É–ª–∏—Ç–∫—É'.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 15‚Äì20 —Ä–∞–∑", 
                video: "v2_7.mp4",
                icon: "fas fa-running"
            }
        ]
    },
    {
        day: "–î–ï–ù–¨ 3: –ü–ª–µ—á–∏ + –†—É–∫–∏ + –ö–æ—Ä",
        exercises: [
            { 
                name: "–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è (–ü–ª–µ—á–∏)", 
                tech: "‚úÖ –°—è–¥—å—Ç–µ, –ø–ª–æ—Ç–Ω–æ –ø—Ä–∏–∂–º–∏—Ç–µ—Å—å —Å–ø–∏–Ω–æ–π. –ì–∞–Ω—Ç–µ–ª–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —É—à–µ–π.\n‚úÖ –í—ã–∂–º–∏—Ç–µ –≥–∞–Ω—Ç–µ–ª–∏ –≤–≤–µ—Ä—Ö –ø–æ –¥—É–≥–µ, —Å–≤–æ–¥—è –∏—Ö –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π.\n‚úÖ –ü–ª–∞–≤–Ω–æ –æ–ø—É—Å—Ç–∏—Ç–µ –¥–æ —É—Ä–æ–≤–Ω—è —É—à–µ–π.", 
                volume: "4 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 8‚Äì12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v3_1.mp4",
                icon: "fas fa-angle-double-up"
            },
            { 
                name: "–†–∞–∑–≤–µ–¥–µ–Ω–∏–µ –≥–∞–Ω—Ç–µ–ª–µ–π –≤ —Å—Ç–æ—Ä–æ–Ω—ã (–ú–∞—Ö–∏)", 
                tech: "‚úÖ –í—Å—Ç–∞–Ω—å—Ç–µ –ø—Ä—è–º–æ, –Ω–µ–±–æ–ª—å—à–æ–π –Ω–∞–∫–ª–æ–Ω –≤–ø–µ—Ä–µ–¥.\n‚úÖ –ü–æ–¥–Ω–∏–º–∞–π—Ç–µ —Ä—É–∫–∏ —á–µ—Ä–µ–∑ —Å—Ç–æ—Ä–æ–Ω—ã. –õ–æ–∫–æ—Ç—å –≤—ã—à–µ –∫–∏—Å—Ç–∏, –º–∏–∑–∏–Ω–µ—Ü –≤—ã—à–µ –±–æ–ª—å—à–æ–≥–æ –ø–∞–ª—å—Ü–∞.\n‚úÖ –¢–æ–ª—å–∫–æ –¥–æ –ø–∞—Ä–∞–ª–ª–µ–ª–∏ —Å –ø–æ–ª–æ–º.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 12‚Äì15 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v3_2.mp4",
                icon: "fas fa-arrows-alt-h"
            },
            { 
                name: "–û–±—Ä–∞—Ç–Ω—ã–µ —Ä–∞–∑–≤–µ–¥–µ–Ω–∏—è (–ó–∞–¥–Ω—è—è –¥–µ–ª—å—Ç–∞)", 
                tech: "‚úÖ –°—è–¥—å—Ç–µ –ª–∏—Ü–æ–º –∫ —Å–ø–∏–Ω–∫–µ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–∞.\n‚úÖ –û—Ç–≤–æ–¥–∏—Ç–µ –ø—Ä—è–º—ã–µ —Ä—É–∫–∏ –Ω–∞–∑–∞–¥ —Ç–∞–∫ –¥–∞–ª–µ–∫–æ, –∫–∞–∫ –º–æ–∂–µ—Ç–µ.\n‚úÖ –ß—É–≤—Å—Ç–≤—É–π—Ç–µ –∑–∞–¥ –ø–ª–µ—á, –∞ –Ω–µ —Å–ø–∏–Ω—É.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 12‚Äì15 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v3_3.mp4",
                icon: "fas fa-arrow-right"
            },
            { 
                name: "–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–∞ –±–ª–æ–∫–µ (–¢—Ä–∏—Ü–µ–ø—Å)", 
                tech: "‚úÖ –ü—Ä–∏–∂–º–∏—Ç–µ –ª–æ–∫—Ç–∏ –∫ –∫–æ—Ä–ø—É—Å—É.\n‚úÖ –†–∞–∑–≥–∏–±–∞–π—Ç–µ —Ä—É–∫–∏ –≤–Ω–∏–∑. –í –Ω–∏–∂–Ω–µ–π —Ç–æ—á–∫–µ —Ä–∞–∑–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ü—ã –∫–∞–Ω–∞—Ç–∞.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 12‚Äì15 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v3_4.mp4",
                icon: "fas fa-angle-down"
            },
            { 
                name: "–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º –ª–µ–∂–∞", 
                tech: "‚úÖ –°–≥–∏–±–∞–π—Ç–µ —Ä—É–∫–∏, –∑–∞–≤–æ–¥—è –≥—Ä–∏—Ñ –≥–ª—É–±–æ–∫–æ –∑–∞ –≥–æ–ª–æ–≤—É.\n‚úÖ –õ–æ–∫—Ç–∏ —Å–º–æ—Ç—Ä—è—Ç –≤ –ø–æ—Ç–æ–ª–æ–∫.\n‚úÖ –ü–æ—á—É–≤—Å—Ç–≤—É–π—Ç–µ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ —Ç—Ä–∏—Ü–µ–ø—Å–∞ –∏ –≤—ã–∂–º–∏—Ç–µ –≤–≤–µ—Ä—Ö.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 10‚Äì12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v3_5.mp4",
                icon: "fas fa-weight"
            },
            { 
                name: "–°–≥–∏–±–∞–Ω–∏–µ —Ä—É–∫ —Å —Å—É–ø–∏–Ω–∞—Ü–∏–µ–π (–ë–∏—Ü–µ–ø—Å)", 
                tech: "‚úÖ –ù–∞—á–∏–Ω–∞–π—Ç–µ –ø–æ–¥—ä–µ–º, —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—è –∫–∏—Å—Ç—å –Ω–∞—Ä—É–∂—É.\n‚úÖ –í –≤–µ—Ä—Ö–Ω–µ–π —Ç–æ—á–∫–µ –º–∏–∑–∏–Ω–µ—Ü –≤—ã—à–µ –±–æ–ª—å—à–æ–≥–æ –ø–∞–ª—å—Ü–∞.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 10‚Äì12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v3_6.mp4",
                icon: "fas fa-dumbbell"
            },
            { 
                name: "–ú–æ–ª–æ—Ç–∫–∏", 
                tech: "‚úÖ –õ–∞–¥–æ–Ω–∏ —Å–º–æ—Ç—Ä—è—Ç –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ –≤—Å–µ –≤—Ä–µ–º—è. –ë–µ–∑ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 10‚Äì12 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π", 
                video: "v3_7.mp4",
                icon: "fas fa-hammer"
            },
            { 
                name: "–†—É—Å—Å–∫–∏–π —Ç–≤–∏—Å—Ç", 
                tech: "‚úÖ –°–∏–¥—è, –Ω–æ–≥–∏ –Ω–∞ –≤–µ—Å—É, –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–π—Ç–µ –∫–æ—Ä–ø—É—Å –≤ —Å—Ç–æ—Ä–æ–Ω—ã.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 20 —Ä–∞–∑", 
                video: "v3_8.mp4",
                icon: "fas fa-sync-alt"
            },
            { 
                name: "–ú–æ–ª–∏—Ç–≤–∞ –Ω–∞ –±–ª–æ–∫–µ", 
                tech: "‚úÖ –°—Ç–æ—è –Ω–∞ –∫–æ–ª–µ–Ω—è—Ö, —Å–∫—Ä—É—á–∏–≤–∞–π—Ç–µ—Å—å –≤–Ω–∏–∑ —Å–∏–ª–æ–π –ø—Ä–µ—Å—Å–∞.", 
                volume: "3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 15‚Äì20 —Ä–∞–∑", 
                video: "v3_9.mp4",
                icon: "fas fa-pray"
            }
        ]
    }
];

// === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
let curDay = null;
let curExIdx = 0;
let logs = JSON.parse(localStorage.getItem('magic_gym_logs')) || [];
let chartObj = null;
let restTimer = null;
let restTimeLeft = 0;
let cachedVideos = JSON.parse(localStorage.getItem('magic_gym_video_cache')) || {};

// === –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–ò–î–ï–û KINESCOPE ===

function getVideoUrl(filename) {
    const videoId = KINESCOPE_VIDEOS[filename];
    if (!videoId) return null;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    if (cachedVideos[videoId]) {
        return cachedVideos[videoId].url;
    }
    
    return `https://kinescope.io/embed/${videoId}`;
}

function loadKinescopeVideo(videoId, autoplay = true) {
    if (kinescopePlayer) {
        kinescopePlayer.destroy();
    }
    
    const container = document.getElementById('kinescope-player-container');
    if (!container) return;
    
    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    container.innerHTML = '<div id="kinescope-player"></div>';
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–ª–µ–µ—Ä
    kinescopePlayer = new Kinescope.Player('kinescope-player', {
        videoId: videoId,
        width: '100%',
        height: '100%',
        autoplay: autoplay,
        controls: true,
        title: false,
        ui: 'normal'
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
    cacheVideo(videoId);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    kinescopePlayer.on('ready', () => {
        console.log('Kinescope player ready');
        showToast('–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é');
    });
    
    kinescopePlayer.on('error', (error) => {
        console.error('Kinescope error:', error);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ');
    });
    
    kinescopePlayer.on('end', () => {
        console.log('Video ended');
    });
}

function cacheVideo(videoId) {
    if (!cachedVideos[videoId]) {
        cachedVideos[videoId] = {
            url: `https://kinescope.io/embed/${videoId}`,
            cachedAt: Date.now()
        };
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä)
        const keys = Object.keys(cachedVideos);
        if (keys.length > 20) {
            // –£–¥–∞–ª—è–µ–º —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏
            const sorted = keys.sort((a, b) => cachedVideos[a].cachedAt - cachedVideos[b].cachedAt);
            sorted.slice(0, 5).forEach(key => delete cachedVideos[key]);
        }
        
        localStorage.setItem('magic_gym_video_cache', JSON.stringify(cachedVideos));
    }
}

// === –¢–ê–ô–ú–ï–† –û–¢–î–´–•–ê ===

function startRestTimer(seconds = 60) {
    stopRestTimer();
    
    restTimeLeft = seconds;
    
    const container = document.getElementById('rest-timer-container');
    container.innerHTML = `
        <div class="rest-timer">
            <div class="rest-timer-label">–¢–ê–ô–ú–ï–† –û–¢–î–´–•–ê</div>
            <div class="rest-timer-time">${formatTime(restTimeLeft)}</div>
            <div class="rest-timer-controls">
                <button onclick="pauseResumeTimer()" style="background: rgba(255,255,255,0.2);">
                    <i class="fas fa-pause"></i>
                </button>
                <button onclick="addTime(30)" style="background: rgba(255,255,255,0.2);">
                    +30—Å
                </button>
                <button onclick="stopRestTimer()" style="background: rgba(255,59,48,0.3);">
                    <i class="fas fa-stop"></i>
                </button>
            </div>
        </div>
    `;
    
    container.classList.remove('hidden');
    
    restTimer = setInterval(() => {
        restTimeLeft--;
        
        const timeElement = container.querySelector('.rest-timer-time');
        if (timeElement) {
            timeElement.textContent = formatTime(restTimeLeft);
        }
        
        if (restTimeLeft <= 0) {
            stopRestTimer();
            showToast('‚è∞ –í—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å!');
            
            // –í–∏–±—Ä–æ-–æ—Ç–∫–ª–∏–∫ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
        localStorage.setItem('rest_timer', JSON.stringify({
            timeLeft: restTimeLeft,
            startedAt: Date.now() - (seconds - restTimeLeft) * 1000
        }));
    }, 1000);
    
    showToast(`–¢–∞–π–º–µ—Ä –æ—Ç–¥—ã—Ö–∞ –Ω–∞ ${seconds} —Å–µ–∫—É–Ω–¥ –∑–∞–ø—É—â–µ–Ω`);
}

function pauseResumeTimer() {
    if (!restTimer) {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ localStorage
        const saved = JSON.parse(localStorage.getItem('rest_timer'));
        if (saved) {
            const elapsed = Math.floor((Date.now() - saved.startedAt) / 1000);
            const remaining = Math.max(0, saved.timeLeft - elapsed);
            if (remaining > 0) {
                startRestTimer(remaining);
            }
        }
        return;
    }
    
    clearInterval(restTimer);
    restTimer = null;
    
    const container = document.getElementById('rest-timer-container');
    const button = container.querySelector('button:first-child');
    if (button) {
        button.innerHTML = '<i class="fas fa-play"></i>';
    }
}

function addTime(seconds) {
    if (restTimer) {
        restTimeLeft += seconds;
        const timeElement = document.querySelector('.rest-timer-time');
        if (timeElement) {
            timeElement.textContent = formatTime(restTimeLeft);
        }
        showToast(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${seconds} —Å–µ–∫—É–Ω–¥`);
    }
}

function stopRestTimer() {
    if (restTimer) {
        clearInterval(restTimer);
        restTimer = null;
    }
    
    const container = document.getElementById('rest-timer-container');
    container.classList.add('hidden');
    container.innerHTML = '';
    
    localStorage.removeItem('rest_timer');
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.getElementById('screen-' + id).classList.remove('hidden');
    
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    if(id === 'home') {
        document.querySelectorAll('.nav-item')[0].classList.add('active');
        setTimeout(calculateDayProgress, 50);
    }
    if(id === 'stats') { 
        document.querySelectorAll('.nav-item')[1].classList.add('active'); 
        renderStats(); 
    }
    
    window.scrollTo(0, 0);
}

function startWorkout(dayIdx) {
    curDay = program[dayIdx];
    curExIdx = 0;
    showScreen('exercise');
    renderExercise();
    showToast(`–ù–∞—á–∞—Ç–∞ ${curDay.day.split(':')[0]}`);
}

function renderExercise() {
    const ex = curDay.exercises[curExIdx];
    const isLast = curExIdx === curDay.exercises.length - 1;
    const progress = ((curExIdx + 1) / curDay.exercises.length * 100).toFixed(0);
    const videoId = KINESCOPE_VIDEOS[ex.video];
    
    let setsHtml = '';
    for(let i = 1; i <= 4; i++) {
        setsHtml += `<div class="set-row">
            <div class="input-box">
                <label><i class="fas fa-weight"></i> –í–µ—Å (–∫–≥)</label>
                <input type="number" 
                       step="0.5" 
                       id="w-${i}" 
                       placeholder="0" 
                       inputmode="decimal"
                       pattern="[0-9]*"
                       style="font-size: 16px; width: 100%;">
            </div>
            <div class="input-box">
                <label><i class="fas fa-redo"></i> –ü–æ–≤—Ç–æ—Ä—ã</label>
                <input type="number" 
                       id="r-${i}" 
                       placeholder="0" 
                       inputmode="numeric"
                       pattern="[0-9]*"
                       style="font-size: 16px; width: 100%;">
            </div>
        </div>`;
    }

    document.getElementById('ex-content').innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div>
                <p style="color: var(--text-secondary); margin: 0; font-size: 14px;">${curDay.day}</p>
                <h1 style="margin: 4px 0 0 0; font-size: 24px;">
                    <i class="${ex.icon}" style="color: var(--primary); margin-right: 8px;"></i>
                    ${ex.name}
                </h1>
            </div>
            <div style="background: var(--primary); color: white; padding: 8px 12px; border-radius: 20px; font-weight: 600;">
                ${curExIdx + 1}/${curDay.exercises.length}
            </div>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar" style="width: ${progress}%"></div>
        </div>
        
        <div class="video-container">
            <div id="kinescope-player-container" style="width: 100%; height: 100%;">
                <div id="kinescope-player"></div>
            </div>
        </div>
        
        <div class="card" style="text-align: center; padding: 16px;">
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="startRestTimer(60)" style="width: auto; padding: 12px 20px; background: rgba(255,149,0,0.1); color: var(--warning); flex: 1;">
                    <i class="fas fa-clock"></i> –¢–∞–π–º–µ—Ä 60—Å
                </button>
                <button onclick="startRestTimer(90)" style="width: auto; padding: 12px 20px; background: rgba(255,149,0,0.2); color: var(--warning); flex: 1;">
                    <i class="fas fa-clock"></i> –¢–∞–π–º–µ—Ä 90—Å
                </button>
            </div>
        </div>
        
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0;"><i class="fas fa-clipboard-list"></i> –¢–µ—Ö–Ω–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
                <span style="background: rgba(0,122,255,0.1); color: var(--primary); padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                    ${ex.volume}
                </span>
            </div>
            <div class="tech-text">${ex.tech}</div>
        </div>
        
        <div class="card">
            <h3 style="margin-top: 0;"><i class="fas fa-edit"></i> –ó–∞–ø–∏—Å—å –ø–æ–¥—Ö–æ–¥–∞</h3>
            ${setsHtml}
            <button onclick="saveEx()">
                <i class="fas fa-save"></i> ${isLast ? '–ó–ê–í–ï–†–®–ò–¢–¨ –¢–†–ï–ù–ò–†–û–í–ö–£' : '–°–û–•–†–ê–ù–ò–¢–¨ –ò –î–ê–õ–ï–ï'}
            </button>
            <button class="btn-secondary" onclick="confirmExit()">
                <i class="fas fa-times"></i> –í–´–ô–¢–ò –ë–ï–ó –°–û–•–†–ê–ù–ï–ù–ò–Ø
            </button>
        </div>
    `;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ —Å –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
    if (videoId) {
        setTimeout(() => {
            loadKinescopeVideo(videoId, true);
        }, 500);
    }
    
    setTimeout(() => {
        const firstInput = document.getElementById('w-1');
        if (firstInput) firstInput.focus();
    }, 300);
}

function saveEx() {
    const ex = curDay.exercises[curExIdx];
    const results = [];
    
    for(let i = 1; i <= 4; i++) {
        const w = document.getElementById(`w-${i}`).value;
        const r = document.getElementById(`r-${i}`).value;
        if(w && r) {
            results.push({
                w: parseFloat(w),
                r: parseInt(r),
                volume: parseFloat(w) * parseInt(r)
            });
        }
    }
    
    if(results.length > 0) {
        logs.push({
            t: Date.now(),
            d: new Date().toLocaleDateString('ru-RU', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            }),
            n: ex.name,
            s: results,
            totalVolume: results.reduce((sum, s) => sum + s.volume, 0)
        });
        localStorage.setItem('magic_gym_logs', JSON.stringify(logs));
        showToast(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${ex.name}`);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –æ—Ç–¥—ã—Ö–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        if (curExIdx < curDay.exercises.length - 1) {
            startRestTimer(60);
        }
        
        calculateDayProgress();
    }
    
    if(curExIdx < curDay.exercises.length - 1) {
        curExIdx++;
        renderExercise();
    } else {
        const totalVolume = logs.slice(-curDay.exercises.length).reduce((sum, log) => sum + log.totalVolume, 0);
        showToast(`–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –¢–æ–Ω–Ω–∞–∂: ${totalVolume.toFixed(0)}–∫–≥`);
        setTimeout(() => showScreen('home'), 1500);
    }
}

function confirmExit() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞?')) {
        showScreen('home');
    }
}

function syncData() {
    showToast('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
    calculateDayProgress();
}

function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

function calculateDayProgress() {
    if (logs.length === 0) {
        updateProgressBars(0, 0, 0);
        updateWeeklyGoal(0);
        return;
    }
    
    const day1Exercises = program[0].exercises.map(e => e.name);
    const day2Exercises = program[1].exercises.map(e => e.name);
    const day3Exercises = program[2].exercises.map(e => e.name);
    
    const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
    const recentLogs = logs.filter(log => log.t > thirtyDaysAgo);
    
    const completedByDay = { day1: new Set(), day2: new Set(), day3: new Set() };
    
    recentLogs.forEach(log => {
        if (day1Exercises.includes(log.n)) {
            const date = new Date(log.t).toDateString();
            completedByDay.day1.add(date + log.n);
        }
        if (day2Exercises.includes(log.n)) {
            const date = new Date(log.t).toDateString();
            completedByDay.day2.add(date + log.n);
        }
        if (day3Exercises.includes(log.n)) {
            const date = new Date(log.t).toDateString();
            completedByDay.day3.add(date + log.n);
        }
    });
    
    const day1Percent = Math.min(100, (completedByDay.day1.size / (day1Exercises.length * 4)) * 100);
    const day2Percent = Math.min(100, (completedByDay.day2.size / (day2Exercises.length * 4)) * 100);
    const day3Percent = Math.min(100, (completedByDay.day3.size / (day3Exercises.length * 4)) * 100);
    
    updateProgressBars(day1Percent, day2Percent, day3Percent);
    
    const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
    const weeklyVolume = logs
        .filter(log => log.t > sevenDaysAgo)
        .reduce((sum, log) => sum + (log.totalVolume || 0), 0);
    
    updateWeeklyGoal(weeklyVolume);
}

function updateProgressBars(day1Percent, day2Percent, day3Percent) {
    const day1Progress = document.getElementById('day1-progress');
    const day2Progress = document.getElementById('day2-progress');
    const day3Progress = document.getElementById('day3-progress');
    
    const day1PercentEl = document.getElementById('day1-percent');
    const day2PercentEl = document.getElementById('day2-percent');
    const day3PercentEl = document.getElementById('day3-percent');
    
    if (day1Progress) {
        day1Progress.style.width = `${day1Percent}%`;
        day1PercentEl.textContent = `${Math.round(day1Percent)}%`;
    }
    
    if (day2Progress) {
        day2Progress.style.width = `${day2Percent}%`;
        day2PercentEl.textContent = `${Math.round(day2Percent)}%`;
    }
    
    if (day3Progress) {
        day3Progress.style.width = `${day3Percent}%`;
        day3PercentEl.textContent = `${Math.round(day3Percent)}%`;
    }
}

function updateWeeklyGoal(volume) {
    const weeklyGoalEl = document.getElementById('weekly-goal');
    if (weeklyGoalEl) {
        weeklyGoalEl.textContent = `${Math.round(volume)}`;
    }
}

function renderStats() {
    const totalVolume = logs.reduce((sum, log) => sum + (log.totalVolume || 0), 0);
    document.getElementById('total-volume').textContent = `${totalVolume.toFixed(0)} –∫–≥`;
    
    const names = [...new Set(logs.map(l => l.n))];
    const sel = document.getElementById('chart-select');
    sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</option>' + 
        names.map(n => `<option value="${n}">${n}</option>`).join('');
    
    const historyList = document.getElementById('history-list');
    if (logs.length === 0) {
        historyList.innerHTML = `
            <div class="card" style="text-align: center; padding: 40px 20px;">
                <i class="fas fa-chart-line" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 16px;"></i>
                <h3 style="margin: 0 0 8px 0;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                <p style="color: var(--text-secondary); margin: 0;">–ù–∞—á–Ω–∏—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</p>
            </div>
        `;
    } else {
        historyList.innerHTML = logs.slice().reverse().slice(0, 10).map((l, index) => `
            <div class="card" style="padding: 16px; margin-bottom: 12px; position: relative;">
                <button onclick="deleteLog(${logs.length - 1 - index})" style="position: absolute; top: 16px; right: 16px; background: none; border: none; color: var(--danger); font-size: 18px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 15px; background: rgba(255,59,48,0.1);">
                    <i class="fas fa-times"></i>
                </button>
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                        <div style="font-weight: 600; color: var(--primary); font-size: 12px; margin-bottom: 4px;">
                            <i class="far fa-calendar"></i> ${l.d}
                        </div>
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">${l.n}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(0,122,255,0.1), rgba(88,86,214,0.1)); padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                        ${l.totalVolume ? l.totalVolume.toFixed(0) : '0'} –∫–≥
                    </div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${l.s.map(s => `
                        <div style="background: var(--bg); padding: 6px 12px; border-radius: 10px; font-size: 14px; min-width: 80px;">
                            <div style="font-weight: 700;">${s.w} –∫–≥</div>
                            <div style="color: var(--text-secondary); font-size: 12px;">√ó ${s.r} –ø–æ–≤—Ç.</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }
    
    if(names.length > 0) {
        initChart();
    }
}

function deleteLog(index) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        logs.splice(index, 1);
        localStorage.setItem('magic_gym_logs', JSON.stringify(logs));
        renderStats();
        calculateDayProgress();
        showToast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
    }
}

function clearHistory() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫?')) {
        logs = [];
        localStorage.setItem('magic_gym_logs', JSON.stringify(logs));
        renderStats();
        calculateDayProgress();
        showToast('–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
    }
}

function initChart() {
    const name = document.getElementById('chart-select').value;
    if (!name) return;
    
    const filtered = logs.filter(l => l.n === name).sort((a, b) => a.t - b.t);
    if (filtered.length === 0) return;
    
    const ctx = document.getElementById('mainChart').getContext('2d');
    
    if(chartObj) chartObj.destroy();
    
    const dates = filtered.map(f => f.d.split(',')[0]);
    const maxWeights = filtered.map(f => Math.max(...f.s.map(s => s.w)));
    const volumes = filtered.map(f => f.totalVolume || 0);
    
    chartObj = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [
                {
                    label: '–ú–∞–∫—Å. –≤–µ—Å (–∫–≥)',
                    data: maxWeights,
                    borderColor: '#007aff',
                    backgroundColor: 'rgba(0, 122, 255, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y'
                },
                {
                    label: '–¢–æ–Ω–Ω–∞–∂ (–∫–≥)',
                    data: volumes,
                    borderColor: '#34c759',
                    backgroundColor: 'rgba(52, 199, 89, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += context.parsed.y.toFixed(context.dataset.label.includes('–¢–æ–Ω–Ω–∞–∂') ? 0 : 1);
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    },
                    title: {
                        display: true,
                        text: '–í–µ—Å (–∫–≥)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false,
                    },
                    title: {
                        display: true,
                        text: '–¢–æ–Ω–Ω–∞–∂ (–∫–≥)'
                    }
                }
            }
        }
    });
}

function initApp() {
    calculateDayProgress();
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
    const savedTimer = JSON.parse(localStorage.getItem('rest_timer'));
    if (savedTimer) {
        const elapsed = Math.floor((Date.now() - savedTimer.startedAt) / 1000);
        const remaining = Math.max(0, savedTimer.timeLeft - elapsed);
        if (remaining > 0) {
            startRestTimer(remaining);
        }
    }
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/MagicTraining/sw.js')
            .then(() => {
                console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
            })
            .catch(error => {
                console.log('–û—à–∏–±–∫–∞ Service Worker:', error);
            });
    }
    
    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    setTimeout(() => {
        if (logs.length === 0) {
            showToast('üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É');
        }
    }, 1000);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à–∏ Enter
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.target.matches('input')) {
        const btn = document.querySelector('#ex-content button');
        if (btn) btn.click();
    }
});

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('visibilitychange', function() {
    if (document.hidden && restTimer) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        localStorage.setItem('rest_timer', JSON.stringify({
            timeLeft: restTimeLeft,
            startedAt: Date.now() - (restTimeLeft - restTimeLeft) * 1000
        }));
    }
});

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', initApp);
</script>
</body>
</html>
